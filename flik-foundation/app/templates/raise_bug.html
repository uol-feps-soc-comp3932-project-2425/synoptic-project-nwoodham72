{% extends "base.html" %}
{% block title %}Report Bug - Flik{% endblock %}

{% block content %}
  <!-- Field styling -->
  <style>
    .is-warning {
      border-color: #ffc107 !important;
      box-shadow: 0 0 0 0.25rem rgba(255,193,7,0.25);
    }
    /* Remove focus outline from all inputs */
    #title:focus {
      outline: none;
      box-shadow: none;
    }

    #role:focus {
      outline: none;
      box-shadow: none;
    }

    #page:focus {
      outline: none;
      box-shadow: none;
    }

    #description:focus {
      outline: none;
      box-shadow: none;
    }

    #expected:focus{
      outline: none;
      box-shadow: none;
    }
  </style>

  <h1 class="mb-3">Report a Bug</h1>
  <p class="text-muted">Please provide details about the issue you encountered.</p>

  {% if matching_doc %}
    <div class="alert alert-warning shadow-sm">
      <h5 class="alert-heading">We're not quite sure that's a bug...</h5>
      <h6>Your bug report was similar to the provider's documentation. Please check your role and documentation below to see if it resolves your issue.</h3><br><br>
      <p>
        <strong><em>{{ matching_doc.title }}</strong></em>
        Permitted Roles: <i>{{ permitted_roles }}</i>
        Action: <i>{{ matching_doc.action }}</i>
      </p>
    </div>
  {% endif %}


  {% if bug_details %}
    <div class="alert alert-success shadow-sm text-center">
      <img src="/static/images/bug.png" alt="Flik Logo" class="img-fluid mb-2" style="max-width: 50px;"> <!-- Bootstrap 5.2 images (https://icons.getbootstrap.com/) -->
      <h5 class="alert-heading">It's a bug!</h5>
      <p>
        Your bug has been sent to the development team to be resolved. Thank you for taking the time to report this bug through Flik.
        Please note that the development team may reach out to you for further details if required.
      </p>
    </div>
  {% endif %}

  <div class="card shadow-sm border-0 rounded-3">
    <div class="card-body">
      <form method="POST" novalidate>
        {{ form.hidden_tag() }}
        <!-- Multi-Step Form Container -->
        <div class="form-steps-container">
          <div class="form-steps-inner" id="formStepsInner">

            <!-- Step 1 -->
            <div class="form-step" id="step1">
              <!-- Title with floating label and validation feedback -->
              <div class="form-floating mb-3">
                {{ form.title(class="form-control", placeholder="Bug Title") }}
                <label for="title">Please give your bug a title</label>
                <div id="description-helpblock" class="form-text">
                  Your title must be at least 10 characters.
                </div>
                <div class="invalid-feedback">
                  Title must be at least 10 characters.
                </div>
              </div>

              <div class="row">
                <!-- Role select with floating label -->
                <div class="col-md-6 mb-3">
                  <div class="form-floating">
                    {{ form.role(class="form-select") }}
                    <label for="role">{{ form.role.label.text }}</label>
                    <div class="invalid-feedback">
                      Please select a user role.
                    </div>
                  </div>
                </div>
                <!-- Page select with floating label -->
                <div class="col-md-6 mb-3">
                  <div class="form-floating">
                    {{ form.page(class="form-select", placeholder="What page are you on...?") }}
                    <label for="page">{{ form.page.label.text }}</label>
                    <div class="invalid-feedback">
                      Please select a page.
                    </div>
                  </div>
                </div>
              </div>

              <!-- Description -->
              <div class="form-floating mb-3">
                {{ form.description(class="form-control", placeholder="Describe the issue, what happened?", aria_describedby="description-helpblock", style="height: 130px;") }}
                <label for="description">Describe the issue, what happened?</label>
                <div id="description-helpblock" class="form-text">
                  Please describe what you are trying to do. What happens, and what error messages do you encounter? (Minimum 100 characters). See an example bug ticket <a href="#" data-bs-toggle="modal" data-bs-target="#step1-modal">here</a>.
                </div>
                <div class="invalid-feedback">
                  Description must be at least 30 characters.
                </div>
              </div>

              <div class="d-grid">
                <button id="next-btn" type="button" class="btn btn-primary" onclick="validateStep1()">
                  Next
                </button>
              </div>
            </div>

            <!-- Step 2 -->
            <div class="form-step" id="step2">
              <div class="form-floating mb-3">
                {{ form.expected(class="form-control", placeholder="What should have happened instead?", aria_describedby="expected-helpblock", style="height: 100px;") }}
                <label for="expected">What did you expect to happen instead?</label>
                <div id="expected-helpblock" class="form-text">
                  Please describe what you expected to happen or see, or what you thought your role should have been able to do. (Minimum 30 characters). See an example bug ticket <a href="#" data-bs-toggle="modal" data-bs-target="#step2-modal">here</a>.
                </div>
                <div class="invalid-feedback">
                  Expected behaviour must be at least 30 characters.
                </div>
              </div>
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" onclick="prevStep()">Previous</button>
                <button type="submit" id="submit-btn" class="btn btn-primary" disabled>Submit Bug</button>
              </div>
            </div>

          </div> <!-- /.form-steps-inner -->
        </div> <!-- /.form-steps-container -->
      </form>
    </div>
  </div>

  <!-- Modal for Example Bug Ticket -->
  <div class="modal fade" id="step1-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Example</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Bug Title: </strong>Cannot log into platform after updating password</p>
          <p><strong>Description: </strong>I am trying to log in with valid credentials into the Student portal. When I click login it says that my account is not recognised, and it seems that your reset password link is not working either. I also get a 403 error and the system crashes.</p>
          <p><strong>What should have happened instead? (next page): </strong>I should have been able to log in and access my dashboard.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 2 modal -->
  <div class="modal fade" id="step2-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Example</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Bug Title (previous page): </strong>Cannot log into platform after updating password</p>
          <p><strong>Description (previous page): </strong>I have reset the password on my account. When I try to log into the platform with valid credentials, the page freezes and I get a 403 error saying I do not have permission to log in.</p>
          <p><strong>What should have happened instead?: </strong>I should have been able to log in and access my dashboard.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Listeners and Formatting -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const titleInput = document.getElementById('title');
      const descInput = document.getElementById('description');
      const roleSelect = document.getElementById('role');
      const pageSelect = document.getElementById('page');
      const expected_input = document.getElementById('expected');

      // Title field formatting
      titleInput.addEventListener('input', function(e) {
        const value = e.target.value.trim();
        if (value.length > 0 && value.length < 10) {
          e.target.classList.remove('is-invalid', 'is-valid');
          e.target.classList.add('is-warning');
        } else if (value.length >= 10) {
          e.target.classList.remove('is-invalid', 'is-warning');
          e.target.classList.add('is-valid');
        } else {
          e.target.classList.remove('is-invalid', 'is-warning', 'is-valid');
        }
      });
      // On blur, if title is too short, mark it red
      titleInput.addEventListener('blur', function(e) {
        const value = e.target.value.trim();
        if (value.length > 0 && value.length < 10) {
          e.target.classList.remove('is-warning');
          e.target.classList.add('is-invalid');
        }
      });

      // Description field formatting
      descInput.addEventListener('input', function(e) {
        const value = e.target.value.trim();
        if (value.length > 0 && value.length < 100) {
          e.target.classList.remove('is-invalid', 'is-valid');
          e.target.classList.add('is-warning');
        } else if (value.length >= 100) {
          e.target.classList.remove('is-invalid', 'is-warning');
          e.target.classList.add('is-valid');
        } else {
          e.target.classList.remove('is-invalid', 'is-warning', 'is-valid');
        }
      });
      // On blur, if description is too short, mark it red
      descInput.addEventListener('blur', function(e) {
        const value = e.target.value.trim();
        if (value.length > 0 && value.length < 100) {
          e.target.classList.remove('is-warning');
          e.target.classList.add('is-invalid');
        }
      });

      // Role select formatting
      roleSelect.addEventListener('change', function(e) {
        const value = e.target.value.trim();
        if (value !== '') {
          e.target.classList.remove('is-invalid');
          e.target.classList.add('is-valid');
        } else {
          e.target.classList.remove('is-valid');
          e.target.classList.add('is-invalid');
        }
      });

      // Page select formatting
      pageSelect.addEventListener('change', function(e) {
        const value = e.target.value.trim();
        if (value !== '') {
          e.target.classList.remove('is-invalid');
          e.target.classList.add('is-valid');
        } else {
          e.target.classList.remove('is-valid');
          e.target.classList.add('is-invalid');
        }
      });

      // Expected field formatting
      expected_input.addEventListener('input', function(e) {
        const value = e.target.value.trim();
        if (value.length > 0 && value.length < 30) {
          e.target.classList.remove('is-invalid', 'is-valid');
          e.target.classList.add('is-warning');
        } else if (value.length >= 10) {
          e.target.classList.remove('is-invalid', 'is-warning');
          e.target.classList.add('is-valid');
        } else {
          e.target.classList.remove('is-invalid', 'is-warning', 'is-valid');
        }
      });
      // On blur, if expected field is too short, mark it red
      expected_input.addEventListener('blur', function(e) {
        const value = e.target.value.trim();
        if (value.length > 0 && value.length < 30) {
          e.target.classList.remove('is-warning');
          e.target.classList.add('is-invalid');
        }
      });
  
    });
  </script>

  <!-- Validation for Step 1 on Next button click -->
  <script>
    function validateStep1() {
      const titleInput = document.getElementById('title');
      const roleInput = document.getElementById('role');
      const pageInput = document.getElementById('page');
      const descInput = document.getElementById('description');
      let valid = true;

      // Validate Title (min 10 characters)
      if (titleInput.value.trim().length < 10) {
        titleInput.classList.add('is-invalid');
        titleInput.classList.remove('is-valid');
        valid = false;
      } else {
        titleInput.classList.remove('is-invalid');
        titleInput.classList.add('is-valid');
      }

      // Validate Role (must not be empty)
      if (roleInput.value.trim() === '') {
        roleInput.classList.add('is-invalid');
        roleInput.classList.remove('is-valid');
        valid = false;
      } else {
        roleInput.classList.remove('is-invalid');
        roleInput.classList.add('is-valid');
      }

      // Validate Page (must not be empty)
      if (pageInput.value.trim() === '') {
        pageInput.classList.add('is-invalid');
        pageInput.classList.remove('is-valid');
        valid = false;
      } else {
        pageInput.classList.remove('is-invalid');
        pageInput.classList.add('is-valid');
      }

      // Validate Description (min 100 characters)
      if (descInput.value.trim().length < 100) {
        descInput.classList.add('is-invalid');
        descInput.classList.remove('is-valid');
        valid = false;
      } else {
        descInput.classList.remove('is-invalid');
        descInput.classList.add('is-valid');
      }

      if (valid) {
        nextStep();
      }
    }

    function nextStep() {
      document.getElementById('formStepsInner').style.transform = 'translateX(-50%)';
    }
    function prevStep() {
      document.getElementById('formStepsInner').style.transform = 'translateX(0)';
    }
  </script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const expectedInput = document.getElementById('expected');
    const submitBtn = document.getElementById('submit-btn');
    
    expectedInput.addEventListener('input', function(e) {
      const value = e.target.value.trim();
      if(value.length >= 30) {
         submitBtn.disabled = false;
         expectedInput.classList.remove('is-warning', 'is-invalid');
         expectedInput.classList.add('is-valid');
      } else {
         submitBtn.disabled = true;
         expectedInput.classList.remove('is-valid');
         expectedInput.classList.add('is-warning');
      }
    });
  });
</script>
{% endblock %}
