{% extends "base.html" %}

{% block title %}Flik - Teamsheet{% endblock %}

{% block content %}
<h2>Developer Teamsheet</h2>
<p class="text-muted">
    {% if is_manager %}
        Click on a profile to update your own and other developer's skills.
    {% else %}
        Click on your profile to update your skills to ensure you get the right tickets.
    {% endif %}
</p>

{% if developers %}
    <div class="list-group">
        {% for dev in developers %}
            <div class="mb-4">
                {% if dev.id == current_user.id or is_manager %}
                    <!-- Editable for own/manager view -->
                    <a class="list-group-item list-group-item-action mb-1"
                        data-bs-toggle="offcanvas"
                        href="#offcanvas{{ dev.id }}"
                        role="button"
                        aria-controls="offcanvas{{ dev.id }}">
                        {{ dev.email }}
                        {% if dev.id == current_user.id %}<span>(you)</span>{% endif %}
                        <span class="badge bg-secondary ms-2">{{ dev.role.name }}</span>
                    </a>
                {% else %}
                    <!-- Non editable for developers -->
                    <div class="list-group-item mb-1 text-muted">
                        {{ dev.email }}
                        <span class="badge bg-secondary ms-2">{{ dev.role.name }}</span>
                    </div>
                {% endif %}
            
                <!-- Skills -->
                <div class="mt-2">
                    {% for skill in dev.skills %}
                        <span class="badge rounded-pill bg-primary me-1">{{ skill.name }}</span>
                    {% endfor %}
                </div>
            </div>

            <!-- Offcanvas Panel -->
            <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvas{{ dev.id }}" aria-labelledby="offcanvasLabel{{ dev.id }}">
                <div class="offcanvas-header">
                    <h5 id="offcanvasLabel{{ dev.id }}">Skills for {{ dev.email }}</h5>
                    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <form method="POST">
                        <input type="hidden" name="user_id" value="{{ dev.id }}">
                        <input type="text" class="form-control mb-3" placeholder="Search skills..." onkeyup="filterSkills(this, '{{ dev.id }}')">
                        
                        <!-- SKill checklist -->
                        <div class="skill-list">
                            {% for skill in skills|sort(attribute='name') %}
                                {% set is_checked = skill in dev.skills %}
                                <div class="form-check skill-item skill-{{ dev.id }}" style="order: {{ 0 if is_checked else 1 }}">
                                    <input class="form-check-input" type="checkbox" name="skills" value="{{ skill.id }}"
                                        {% if is_checked %} checked {% endif %}>
                                    <label class="form-check-label">{{ skill.name }}</label>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="text-end mt-3">
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <p class="text-muted"><i>No developers found.</i></p>
{% endif %}

<style>
    .skill-list {
        max-height: 400px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
</style>

<script>
    function filterSkills(input, devId) {
        const filter = input.value.toLowerCase();
        const skills = document.querySelectorAll('.skill-' + devId);
        skills.forEach(skill => {
            const label = skill.textContent.toLowerCase();
            skill.style.display = label.includes(filter) ? '' : 'none';
        });
    }
</script>
{% endblock %}
